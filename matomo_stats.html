<script>
document.addEventListener("DOMContentLoaded", function() {
    var matomoBaseUrl = "https://sitelf.fr/matomo/";
    var siteId = "4"; 
    var domId = "page-views";

    // 1. DÉTECTION DE L'URL CIBLE
    // Si on est en local (preview), on simule l'URL de production pour voir les vraies stats
    var isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
    var productionHost = "tnsi.sitelf.fr"; // L'URL publique de votre site
    
    var hostname = isLocal ? productionHost : window.location.hostname;
    // Si on est en local on force https car le site prod est en https
    var protocol = isLocal ? "https:" : window.location.protocol;
    
    // On enlève index.html si présent, car Matomo le fait parfois
    var pathname = window.location.pathname; // .replace(/\/index\.html$/, '/'); 
    
    var targetUrl = protocol + '//' + hostname + pathname;

    // 2. MÉTHODE JSONP (Bypasse le blocage CORS)
    var callbackName = 'matomo_jsonp_callback_' + Math.floor(Math.random() * 10000);

    // Fonction qui recevra les données
    window[callbackName] = function(data) {
        var hits = 0;
        // Matomo renvoie un tableau ou un objet selon le contexte
        if (Array.isArray(data) && data.length > 0 && data[0].nb_hits) {
            hits = data[0].nb_hits;
        } else if (typeof data === 'object' && data.nb_hits) {
            hits = data.nb_hits;
        }
        
        // Mise à jour de l'affichage
        var element = document.getElementById(domId);
        if (element) {
            element.innerHTML = '<i class="fa-solid fa-eye"></i> ' + hits + ' vues';
            element.title = "Vues totales depuis la création (URL: " + targetUrl + ")";
            // Si 0, on peut vouloir déboguer :
            if (hits === 0) console.log("Matomo : 0 vues trouvées pour " + targetUrl);
        }
        
        // Nettoyage
        delete window[callbackName];
        var script = document.getElementById(callbackName);
        if (script) script.remove();
    };

    // Construction de l'URL API avec callback
    var apiUrl = matomoBaseUrl + "index.php?module=API&method=Actions.getPageUrl" + 
                 "&idSite=" + siteId + 
                 "&pageUrl=" + encodeURIComponent(targetUrl) + 
                 "&format=JSON" + 
                 "&period=range&date=2018-01-01,today" + 
                 "&token_auth=anonymous" +
                 "&jsoncallback=" + callbackName; // Le paramètre clé pour JSONP

    // Injection du script
    var script = document.createElement('script');
    script.id = callbackName;
    script.src = apiUrl;
    script.onerror = function() {
        console.log('Info: Impossible de récupérer les stats Matomo (Erreur réseau ou bloqueur)');
    };
    document.body.appendChild(script);
});
</script>
