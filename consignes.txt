CONSIGNES POUR Lâ€™IA â€” Corriger un compteur de vues Matomo sur un site Quarto

Objectif
- Afficher un compteur de vues dans le footer de chaque page.
- Faire correspondre le nombre affichÃ© avec le tableau de bord Matomo (mÃªme logique de regroupement), et pas seulement une URL exacte.

Contexte cible
- Site statique Quarto.
- Matomo dÃ©jÃ  installÃ© (script de tracking prÃ©sent).
- Un Ã©lÃ©ment HTML existe dans le footer, par exemple : <span id="page-views"></span>

Ce que lâ€™IA doit faire (ordre strict)

1) VÃ©rifier le point dâ€™injection du compteur
- Confirmer quâ€™un Ã©lÃ©ment existe pour afficher la valeur : id="page-views".
- Sâ€™il nâ€™existe pas, lâ€™ajouter dans le footer Quarto (dans _quarto.yml, format.html.footer, ou template Ã©quivalent).

2) Ã‰viter les doublons Matomo
- VÃ©rifier les includes Quarto (souvent format.html.include-in-header).
- Garder UNE seule inclusion pour le script Matomo + compteur.
- Supprimer les doublons (ex: 2 fichiers header qui injectent Matomo en parallÃ¨le).

3) Ajouter/mettre Ã  jour le script global dans le header
- Le script doit :
  - attendre DOMContentLoaded,
  - cibler #page-views,
  - utiliser JSONP (paramÃ¨tre jsoncallback) pour Ã©viter les problÃ¨mes CORS,
  - rÃ©cupÃ©rer le slug de lâ€™article depuis lâ€™URL (cas /posts/<slug>/...),
  - interroger Matomo avec Actions.getPageUrls + expanded=1 + segment=pageUrl=@/posts/<slug>,
  - parcourir rÃ©cursivement la rÃ©ponse pour trouver le nÅ“ud label == <slug> et lire nb_hits,
  - afficher Â« ðŸ‘ X vues Â» (ou icÃ´ne Font Awesome dÃ©jÃ  utilisÃ©e par le site),
  - fallback : si rien trouvÃ©, appeler Actions.getPageUrl avec lâ€™URL exacte,
  - en cas dâ€™erreur finale : afficher Â« indisponible Â».

4) DÃ©tails dâ€™implÃ©mentation Ã  respecter
- Variables configurables en haut du script :
  - matomoBaseUrl (ex: https://example.com/matomo/)
  - siteId
- Pour le fallback URL exacte :
  - construire targetUrl Ã  partir de location,
  - si hostname est localhost/127.0.0.1, utiliser le domaine de prod attendu (option recommandÃ©e) pour Ã©viter les faux comptages preview.
- Nettoyer chaque callback JSONP aprÃ¨s exÃ©cution (delete window[callbackName] + remove script injectÃ©).

5) Validation minimale obligatoire
- Lancer un rendu Quarto (au moins la page test) :
  - quarto render index.qmd
- VÃ©rifier que le script est bien injectÃ© dans le HTML gÃ©nÃ©rÃ©.
- Tester un article connu dans Matomo :
  - la valeur affichÃ©e doit correspondre au regroupement vu dans Â« Actions > Page URLs Â» pour ce slug.

6) CritÃ¨res dâ€™acceptation
- Le compteur nâ€™est plus vide.
- Le compteur reflÃ¨te le mÃªme ordre de grandeur/valeur que Matomo Dashboard (logique Page URLs par slug).
- Pas de double inclusion Matomo dans la config Quarto.
- Pas dâ€™erreur JS dans la console sur la page.

Exemple de script (Ã  adapter)

<script>
document.addEventListener("DOMContentLoaded", function () {
  var matomoBaseUrl = "https://VOTRE_DOMAINE/matomo/";
  var siteId = "2";
  var pageViewsElement = document.getElementById("page-views");

  if (!pageViewsElement) return;

  var isLocal = /^(localhost|127\.0\.0\.1)$/.test(window.location.hostname);
  var productionHost = "VOTRE_DOMAINE_PUBLIC";
  var hostname = isLocal ? productionHost : window.location.hostname;
  var protocol = isLocal ? "https:" : window.location.protocol;
  var pathname = window.location.pathname;
  var targetUrl = protocol + "//" + hostname + pathname;

  var normalizedPath = pathname.replace(/\/index\.html$/, "").replace(/\/$/, "");
  var pathParts = normalizedPath.split("/").filter(Boolean);
  var isPostPage = pathParts.length >= 2 && pathParts[0] === "posts";

  function displayHits(hits) {
    pageViewsElement.innerHTML = '<i class="fa-solid fa-eye"></i> ' + hits + ' vues';
  }

  function cleanupCallback(callbackName) {
    delete window[callbackName];
    var s = document.getElementById(callbackName);
    if (s) s.remove();
  }

  function requestJsonp(url, onSuccess, onError) {
    var callbackName = "matomoCb_" + Math.floor(Math.random() * 1e9);
    window[callbackName] = function (data) {
      cleanupCallback(callbackName);
      onSuccess(data);
    };

    var script = document.createElement("script");
    script.id = callbackName;
    script.src = url + "&jsoncallback=" + callbackName;
    script.onerror = function () {
      cleanupCallback(callbackName);
      onError();
    };
    document.body.appendChild(script);
  }

  function findHitsByLabel(nodes, label) {
    if (!Array.isArray(nodes)) return null;
    for (var i = 0; i < nodes.length; i += 1) {
      var n = nodes[i];
      if (n && n.label === label && typeof n.nb_hits === "number") return n.nb_hits;
      var nested = findHitsByLabel(n && n.subtable, label);
      if (nested !== null) return nested;
    }
    return null;
  }

  function fallbackExactUrl() {
    var url = matomoBaseUrl + "index.php?module=API&method=Actions.getPageUrl"
      + "&idSite=" + siteId
      + "&pageUrl=" + encodeURIComponent(targetUrl)
      + "&format=JSON"
      + "&period=range&date=2018-01-01,today";

    requestJsonp(url, function (data) {
      var hits = 0;
      if (Array.isArray(data) && data.length && typeof data[0].nb_hits === "number") {
        hits = data[0].nb_hits;
      } else if (data && typeof data.nb_hits === "number") {
        hits = data.nb_hits;
      }
      displayHits(hits);
    }, function () {
      pageViewsElement.innerHTML = '<i class="fa-solid fa-eye"></i> indisponible';
    });
  }

  if (!isPostPage) {
    fallbackExactUrl();
    return;
  }

  var slug = pathParts[1];
  var segmentPath = "/posts/" + slug;
  var url = matomoBaseUrl + "index.php?module=API&method=Actions.getPageUrls"
    + "&idSite=" + siteId
    + "&format=JSON"
    + "&expanded=1"
    + "&period=range&date=2018-01-01,today"
    + "&segment=" + encodeURIComponent("pageUrl=@" + segmentPath);

  requestJsonp(url, function (data) {
    var hits = findHitsByLabel(data, slug);
    if (typeof hits === "number") displayHits(hits);
    else fallbackExactUrl();
  }, function () {
    fallbackExactUrl();
  });
});
</script>

Instructions finales pour lâ€™IA
- Appliquer des modifications minimales (pas de refactor global inutile).
- Conserver le style existant du projet.
- Rendre une page et confirmer la correspondance de la valeur sur un article de rÃ©fÃ©rence Matomo.
- Donner un court compte-rendu des fichiers modifiÃ©s et du rÃ©sultat de validation.